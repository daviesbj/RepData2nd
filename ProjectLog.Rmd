Project Log -- Severe Weather Impact Analysis (RDA Project 2)
=============================================================

```{r load necessary library}
library('R.utils')
```

Getting and loading the online data (cached)
--------------------------------------------

```{r Get and Load Online Data, cache = TRUE }
qtDload = TRUE
download.file( 'https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2',
               destfile = 'StormData.csv.bz2', method='curl', quiet = qtDload )
download.file( 'https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf',
               destfile = 'pd01016005curr.pdf', method='curl', quiet = qtDload )
download.file( 'https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf',
               destfile = 'Storm_Events_FAQ.pdf', method='curl', quiet = qtDload )
# install.packages("R.utils")
library('R.utils')
bunzip2( 'StormData.csv.bz2', remove = FALSE, overwrite = TRUE )
s <- read.csv('StormData.csv')
save( s, file = 'stormDataRaw.Robj' )
```

Rough Cleanup
-------------

Check for bad data:

```{r check for bad data, cache = TRUE }
for( colName in colnames( s ) ){
  nNA <- sum( is.na( s[,colName] ) )
  if( nNA > 0 ) message( colName, ': ', nNA, ' missing values' )
}
```

None of those are really relevant to the question being asked.

As I have a limited time to do this analysis, I need to work with the minimum
necessary dataset. At the moment it contains `r length( s$EVTYPE )` records.
So I want events with the following __non-zero__

* FATALITIES
* INJURIES
* PROPDMG
* CROPDMG

```{r Filter nonfatal/injurious/damaging events, cache=TRUE}
wantedEvents <- ( s$FATALITIES>0 | s$INJURIES>0 | s$PROPDMG>0 | s$CROPDMG>0 )
s <- s[wantedEvents,]
```

Now we're down to `r length( s$EVTYPE )` events.

Clean up damage values
----------------------

Now to tidy up the damage values. The problem is the multipliers.

```{r silly multipliers}
table(toupper(as.character(s$PROPDMGEXP))[s$PROPDMG!=0])
table(toupper(as.character(s$CROPDMGEXP))[s$CROPDMG!=0])
```

Will extract these to an array and work there. Set up list of valid __*DMGEXP*__
values first.

```{r fix damage value to numerics, cache=TRUE}
goodexp <- c( 'H', 'K', 'M', 'B' )

p_mantissa <- s$PROPDMG
p_exp <- toupper(as.character(s$PROPDMGEXP))
p_mult <- rep(1,length(p_exp))
p_mult[p_exp=='H'] <- 100
p_mult[p_exp=='K'] <- 1000
p_mult[p_exp=='M'] <- 1e6
p_mult[p_exp=='B'] <- 1e9
p_fixed <- p_mantissa * p_mult
p_fixed[ !(p_exp %in% goodexp) & p_fixed > 0 ] <- NA
summary(p_fixed)

c_mantissa <- s$CROPDMG
c_exp <- toupper(as.character(s$CROPDMGEXP))
c_mult <- rep(1,length(c_exp))
c_mult[c_exp=='H'] <- 100
c_mult[c_exp=='K'] <- 1000
c_mult[c_exp=='M'] <- 1e6
c_mult[c_exp=='B'] <- 1e9
c_fixed <- c_mantissa * c_mult
c_fixed[ !(c_exp %in% goodexp) & c_fixed > 0 ] <- NA
summary(c_fixed)
```

Some of the values look a bit fishy. Specifically, was there REALLY a single
event that cost dollar `r max(p_fixed,na.rm=TRUE)` in property
damage when the all-time total for property damage was
dollar `r sum(p_fixed,na.rm=TRUE)` ?

```{r output fishy hi-cost event}
s[which.max(p_fixed),]
```

A search in Wikipedia for __Napa River Flood__ found a flood in 1986 at
http://en.wikipedia.org/wiki/Napa_River_flood_of_1986 accessed 14 July 2014
which includes the text _"damages totaled $100 million ... Another flood of
lesser proportions occurred on December 31, 2005 after over a week of rain"_
which must mean that the event in the database has got a _B_ instead of an
_M_ in the PROPDMGEXP column. So I'm going to edit out JUST that specific
one (because it's almost a quarter of the total property damage so it's really
egregious), but I don't have the capacity to fix any others.

```{r remove single outlier event}
p_fixed[ !is.na( p_fixed )
         & p_fixed > 1e11 ] <-
  p_fixed[ !is.na( p_fixed)
           & p_fixed > 1e11 ] / 1000
```

Now let's look at the next outlier

```{r output next highest hi-cost event, cache = TRUE}
s[ which.max( p_fixed ), ]
```

That's Katrina, credible at  dollars 31.3 billion
http://en.wikipedia.org/wiki/Hurricane_katrina#Economic_effects accessed
14 July 2014.

What about top crop damage?

```{r Look at max crop damage, cache = TRUE }
max( c_fixed, na.rm = TRUE )
substr(s[which.max(c_fixed),]$REMARKS, 1, 300 )
```

Well, that definitely happened. http://en.wikipedia.org/wiki/Great_flood_of_93#Costs_and_damage
accessed 14 July 2014.

__That's all the time I have available to spend on fixing up damage estimates__

Normalize event categories
--------------------------

Set up a smaller frame __c__ to work with

```{r set up frame c for simplification, cache = TRUE }
evType <- sub( '^ +', '', toupper(as.character(s$EVTYPE)))
c <- data.frame(
  EVTYPE_OLD = evType,
  EVTYPE_NEW = rep( 'other', length(evType)),
  FATALITIES = s$FATALITIES,
  INJURIES = s$INJURIES,
  PROPDMG = p_fixed,
  CROPDMG = c_fixed
  )
c$EVTYPE_OLD <- as.character(c$EVTYPE_OLD)
c$EVTYPE_NEW <- as.character(c$EVTYPE_NEW)
head(c)
```

Add some functions to help monitor progress

```{r some helper functions for cleaning up categories}
# SumCat -- summarize impact of all events matching pattern
SumCat <- function( pattern, set = 'OLD' ){
if( pattern != 'other' ) pattern <- toupper(pattern)
set <- toupper(set)
which <- grep( pattern, c$EVTYPE_OLD )
ntype <- length( levels( as.factor( c$EVTYPE_OLD[which] ) ) )
if( set == 'NEW' ){
  which <- grep( pattern, c$EVTYPE_NEW )
  ntype <- length( levels( as.factor( c$EVTYPE_NEW[which] ) ) )
  }
message( 'In ', set, ' pattern ', pattern, ' matches: ', length( which ), ' events, of ', ntype, ' EVTYPEs' )
message( '   ', sum( c$FATALITIES[which] ), ' FATALITIES' )
message( '   ', sum( c$INJURIES[which] ), ' INJURIES' )
message( '   ', sprintf( '%.2e', sum( c$PROPDMG[which], na.rm=TRUE ) ), ' PROPDMG' )
message( '   ', sprintf( '%.2e', sum( c$CROPDMG[which], na.rm=TRUE ) ), ' CROPDMG' )
}

# Matches() -- enumerate event type matching pattern
Matches <- function( pattern ){
levels( as.factor( evType[ grepl( toupper(pattern), evType ) &
                          ( c$EVTYPE_NEW == 'other' )
                          ] 
                   ) 
        )
}

# Nmatch() -- how many
Nmatch  <- function( pattern ){ length( Matches( pattern ) ) }

# Others() -- which not done yet
Others  <- function(){ levels( as.factor( evType[ c$EVTYPE_NEW == 'other' ] ) ) }

# SetNew() -- allocate new name
SetNew <- function( theFrame, patternFrom, stringTo ){
patternFrom = toupper( patternFrom )
stringTo <- toupper( stringTo )
mlist <- grepl( patternFrom, theFrame$EVTYPE_OLD ) &
  ( theFrame$EVTYPE_NEW == 'other' )
message( 'Replacing ', sum(mlist), ' values' )
theFrame$EVTYPE_NEW[mlist] <- stringTo
theFrame
}
```

So now we do stuff like this

```{r simplify tornadoes TORN, cache = TRUE }
Matches('TORN')
SumCat('TORNADO')
c <- SetNew( c, 'TORN', 'TORNADO' )
```

```{r simplify floods FLOOD, cache = TRUE }
Matches('FLOOD')
SumCat('FLOOD')
c <- SetNew( c, 'FLOOD', 'FLOOD' )
```

```{r simplify hurricanes HURRI, cache = TRUE }
Matches('HURRI')
SumCat('HURRI')
c <- SetNew( c, 'HURRI', 'HURRICANE' )
```

```{r simplify tropical storms and depressions, cache = TRUE }
Matches('TROPI')
SumCat('TROPI')
c <- SetNew( c, 'TROPI', 'TRPCL STORM' )
```

Can't just replace __TSTM__ with __TRPCL STORM__, alas ...

```{r some tropical storms and others TSTM, cache = TRUE }
Matches('TSTM')
c <- SetNew( c, '^NON.TSTM', 'WIND' )
SumCat('TSTM')
c <- SetNew( c, 'TSTM', 'TRPCL STORM' )
```

```{r fixing SNOW, cache = TRUE }
Matches('SNOW')
SumCat('SNOW')
c <- SetNew( c, 'SNOW', 'SNOW' )
```

```{r fixing THUNDER, cache = TRUE }
Matches('THUNDER')
SumCat('THUNDER')
# Someone spells badley
c <- SetNew( c, 'THUNDER',   'THUNDERSTORM' )
c <- SetNew( c, 'THUNDEER',  'THUNDERSTORM' )
c <- SetNew( c, 'THUDER',    'THUNDERSTORM' )
c <- SetNew( c, 'THUNER',    'THUNDERSTORM' )
c <- SetNew( c, 'TUNDER',    'THUNDERSTORM' )
```

__HEAT__ seems to kill a lot of people ...

```{r fixing HEAT, cache = TRUE }
Matches('HEAT')
SumCat('HEAT')
c <- SetNew( c, 'HEAT', 'HEATWAVE' )
```

```{r fixing CHILL, cache = TRUE}
Matches('CHILL')
SumCat('CHILL')
c <- SetNew( c, 'CHILL', 'WINDCHILL' )
```

```{r fixing HAIL, cache = TRUE}
Matches('HAIL')
SumCat('HAIL')
c <- SetNew( c, 'HAIL', 'HAIL' )
```

Can't believe I missed this one ...

```{r fixing WIND, cache = TRUE}
Matches('WIND')
SumCat('WIND')
c <- SetNew( c, 'WIND', 'WIND' )
```

```{r fixing LIGHTNING, cache = TRUE}
Matches('LIG')
SumCat('LIG')
c <- SetNew( c, 'LIG', 'LIGHTNING' )
```

```{r fixing wintry conditions in general, cache = TRUE}
Matches('WINT')
SumCat('WINT')
c <- SetNew( c, 'WINT', 'WINTRY OTHER' )
```

```{r fixing fires in general, cache = TRUE}
Matches('FIRE')
SumCat('FIRE')
c <- SetNew( c, 'FIRE', 'FIRES' )
```

Following command gives top n remaining in category

```{r filter highest-scoring event in category }
WorstN <- function( category, n = 10 ){
o <- c[c$EVTYPE_NEW=='other', ];
o <- o[ order( o[, toupper( category ) ], decreasing=TRUE ), ];
head( o, n )
}
WorstN( 'injuries', 12 )
```

Consolidate a few more ...

```{r some more categories, cache = TRUE }
c <- SetNew( c, 'BLIZZ', 'BLIZZARD' )
c <- SetNew( c, 'DROUGHT', 'DROUGHT' )
c <- SetNew( c, 'ICE STORM', 'ICE STORM' )
c <- SetNew( c, 'STORM SURGE', 'STORM SURGE' )
c <- SetNew( c, 'UNSEASONABLY WARM', 'HEATWAVE' )
c <- SetNew( c, 'COLD', 'XTRM COLD' )
c <- SetNew( c, 'LOW TEMPERATURE', 'XTRM COLD' )
c <- SetNew( c, 'FOG', 'FOG' )
c <- SetNew( c, 'RIP', 'RIP CURRENT' )
c <- SetNew( c, 'DUST', 'DUST STORM' )
c <- SetNew( c, 'SURF', 'SURF' )
c <- SetNew( c, 'LANDSLIDE', 'LANDSLIDE' )
c <- SetNew( c, 'MUDSLIDE', 'MUDSLIDE' )
c <- SetNew( c, 'AVALANCH?E', 'AVALANCHE' )
c <- SetNew( c, 'HYPOTHERMIA', 'HYPOTHERMIA' )
```

Non-freezing rain ...

```{r Most rain,  cache = TRUE }
Matches('RAIN')
Matches('^[^F].*RAIN')
SumCat('^[^F].*RAIN')
c <- SetNew( c, '^[^F].*RAIN', 'RAIN' )
```
Some ice phenomena ...

```{r unpick & fix actual ice, cache = TRUE }
WorstN('injuries')
Matches('ICE|GLAZE')
c <- SetNew( c, 'GLAZE', 'ICE' )
c <- SetNew( c, 'ICE.+ROAD', 'ICE' )
c <- SetNew( c, '^ICE$', 'ICE' )
c <- SetNew( c, 'BLACK ICE', 'ICE' )
```

Some tidying up __FLD__ = 'FLOOD' ...

```{r Fix FLD, cache = TRUE }
Matches('FLD')
c <- SetNew( c, 'FLD', 'FLOOD' )
```

Maritime grab-bag ...

```{r fix offshore, cache = TRUE }
c <- SetNew( c, 'SEA', 'MARITIME' )
c <- SetNew( c, 'MARINE MISHAP', 'MARITIME' )
c <- SetNew( c, 'MARINE ACCIDENT', 'MARITIME' )
c <- SetNew( c, 'TSUNAMI', 'TSUNAMI' )
c <- SetNew( c, 'WATERSPOUT', 'WATERSPOUT' )
```

Finished classifying events!

```{r Final summary of classifications}
# Everything not otherwise classified ...
SumCat( 'other', 'new' )
# List of new classes
levels(as.factor(c$EVTYPE_NEW))
```

That's `r length( levels(as.factor(c$EVTYPE_NEW)))` categories, down from
`r length(levels(as.factor(evType)))` in the filterd dataset.

Get a nice year column
----------------------

Just want the 4-digit year.

```{r get vector of integer years, cache = TRUE}
dateOrig <- as.character(s$BGN_DATE)
nDates <- length( dateOrig )
dateTok <- strsplit( dateOrig, '/| ' )
years <- rep( NA, nDates )
for( i in seq( 1, nDates ) ){ years[i] <- as.integer( dateTok[[i]][3] ) }
summary( years )
c$YEAR <- years
head( c )
```

There's something a bit fishy about the event frequencies through time.
Here goes a nice summary table ...

```{r summary of data by year, cache = TRUE }
notypes <- data.frame( FATALITIES = c$FATALITIES, INJURIES = c$INJURIES,
                       PROPDMG = c$PROPDMG, CROPDMG = c$CROPDMG )

yInc <- aggregate( c$YEAR, list(c$YEAR), length )
yTot <- aggregate(notypes,list(c$YEAR), sum, na.rm=TRUE )
ySum <- data.frame(
  YEAR = yInc$Group.1,
  N = yInc$x,
  DEATHS = yTot$FATALITIES,
  INJURIES = yTot$INJURIES,
  PROPDMG = yTot$PROPDMG,
  CROPDMG = yTot$CROPDMG
  )
ySum
```

Everything changed in 1993. Deaths jumped, and CROPDMG started.
So I'm going to ignore everything before then.

```{r edit out everything pre-1993}
c <- c[c$YEAR>=1993,]
```

Now for a summary of stats by event type

```{r summary of post-1992 by type, cache = TRUE }
notypes <- data.frame( FATALITIES = c$FATALITIES, INJURIES = c$INJURIES,
                       PROPDMG = c$PROPDMG, CROPDMG = c$CROPDMG )

evCnt <- aggregate( c$EVTYPE_NEW, list(c$EVTYPE_NEW), length )
evTot <- aggregate(notypes,list(c$EVTYPE_NEW), sum, na.rm=TRUE )
evSum <- data.frame(
  EVTYPE = evCnt$Group.1,
  N = evCnt$x,
  DEATHS = evTot$FATALITIES,
  INJURIES = evTot$INJURIES,
  PROPDMG = evTot$PROPDMG,
  CROPDMG = evTot$CROPDMG
  )
evSum
```

Now I want to summarize the n worst CATEGORIES since 1993

